<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Bot - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Noto Sans KR', -apple-system, sans-serif;
      background: radial-gradient(ellipse at 50% 0%, #13141f 0%, #0d0e17 50%, #080810 100%);
      color: #e2e4f0;
      min-height: 100vh;
    }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #2d2f45; border-radius: 3px; }
    a { color: inherit; text-decoration: none; }

    /* Login Page */
    .login-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .login-card {
      text-align: center;
      padding: 48px;
      background: linear-gradient(135deg, #13141f88, #1a1b2e88);
      border-radius: 24px;
      border: 1px solid #2d2f4566;
      backdrop-filter: blur(20px);
      max-width: 420px;
      width: 90%;
    }
    .login-icon {
      width: 80px; height: 80px; border-radius: 24px;
      background: linear-gradient(135deg, #5865F2, #7c3aed);
      display: flex; align-items: center; justify-content: center;
      font-size: 40px; margin: 0 auto 24px;
      box-shadow: 0 8px 32px #5865F244;
    }
    .login-btn {
      width: 100%; padding: 14px 24px; border-radius: 12px;
      border: none; background: linear-gradient(135deg, #5865F2, #4752c4);
      color: #fff; font-size: 15px; font-weight: 700; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      box-shadow: 0 4px 16px #5865F233;
      transition: transform 0.1s;
    }
    .login-btn:hover { transform: translateY(-1px); }

    /* Layout */
    .layout { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: 240px; position: fixed; left: 0; top: 0; height: 100vh;
      background: linear-gradient(180deg, #13141f 0%, #0d0e17 100%);
      border-right: 1px solid #1d1f33;
      display: flex; flex-direction: column; z-index: 100;
    }
    .sidebar-logo { padding: 24px 20px; border-bottom: 1px solid #1d1f33; }
    .sidebar-server { padding: 16px 20px; border-bottom: 1px solid #1d1f33; }
    .sidebar-nav { padding: 12px 12px; flex: 1; overflow-y: auto; }
    .sidebar-footer { padding: 16px 20px; border-top: 1px solid #1d1f33; }

    .nav-label {
      font-size: 10px; color: #5d5f7a; text-transform: uppercase;
      letter-spacing: 1.5px; margin-bottom: 8px; padding: 0 8px; font-weight: 700;
    }
    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: 10px; cursor: pointer;
      margin-bottom: 2px; border-left: 3px solid transparent;
      transition: all 0.15s ease; font-size: 13px; color: #8b8db3;
    }
    .nav-item:hover { background: #ffffff08; }
    .nav-item.active {
      background: linear-gradient(135deg, #5865F220, #7c3aed15);
      border-left-color: #5865F2; color: #fff; font-weight: 700;
    }

    /* Main Content */
    .main { margin-left: 240px; padding: 32px 40px; flex: 1; }

    /* Cards */
    .card {
      background: linear-gradient(135deg, #1e1f2e 0%, #252640 100%);
      border-radius: 16px; padding: 24px; border: 1px solid #2d2f45;
    }
    .card-title { font-size: 15px; font-weight: 700; color: #fff; margin-bottom: 16px; }

    /* Stat Cards */
    .stats-grid { display: flex; gap: 16px; margin-bottom: 28px; flex-wrap: wrap; }
    .stat-card { flex: 1; min-width: 180px; }
    .stat-value { font-size: 28px; font-weight: 800; color: #fff; font-family: 'JetBrains Mono', monospace; }
    .stat-label { font-size: 12px; color: #8b8db3; margin-top: 4px; }
    .stat-change { font-size: 12px; font-weight: 600; }
    .stat-change.up { color: #43b581; }
    .stat-change.down { color: #f04747; }

    /* Lists */
    .list-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; background: #1a1b2e; border-radius: 10px;
      margin-bottom: 4px; border: 1px solid #1d1f33;
      transition: background 0.15s;
    }
    .list-item:hover { background: #1f2038; }

    /* Badges */
    .badge {
      display: inline-block; padding: 2px 8px; border-radius: 12px;
      font-size: 11px; font-weight: 600;
    }

    /* Buttons */
    .btn {
      padding: 8px 16px; border-radius: 8px; border: none;
      font-size: 13px; font-weight: 700; cursor: pointer;
      transition: all 0.15s;
    }
    .btn-primary { background: linear-gradient(135deg, #5865F2, #7c3aed); color: #fff; }
    .btn-success { background: #43b581; color: #fff; }
    .btn-danger { background: transparent; border: 1px solid #f0474733; color: #f04747; }
    .btn-warning { background: transparent; border: 1px solid #faa61a44; color: #faa61a; }
    .btn:hover { transform: translateY(-1px); }

    /* Inputs */
    .input {
      padding: 10px 14px; border-radius: 8px; border: 1px solid #2d2f45;
      background: #161726; color: #fff; font-size: 13px; outline: none;
      font-family: inherit; transition: border-color 0.15s;
    }
    .input:focus { border-color: #5865F2; }

    /* Toggle */
    .toggle {
      width: 44px; height: 24px; border-radius: 12px;
      cursor: pointer; position: relative; transition: background 0.2s;
    }
    .toggle.on { background: #43b581; }
    .toggle.off { background: #4d4f6a; }
    .toggle-knob {
      width: 18px; height: 18px; border-radius: 50%;
      background: #fff; position: absolute; top: 3px;
      transition: left 0.2s;
    }

    /* Toast */
    .toast {
      position: fixed; bottom: 24px; right: 24px;
      padding: 12px 24px; background: #1e1f2e;
      border: 1px solid #43b58144; border-radius: 12px;
      color: #43b581; font-size: 13px; font-weight: 600;
      z-index: 1000; box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Loading */
    .loading {
      display: flex; align-items: center; justify-content: center;
      min-height: 200px; color: #5d5f7a; font-size: 14px;
    }
    .spinner {
      width: 24px; height: 24px; border: 3px solid #2d2f45;
      border-top-color: #5865F2; border-radius: 50%;
      animation: spin 0.8s linear infinite; margin-right: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Status dot */
    .status-dot {
      display: inline-block; width: 10px; height: 10px;
      border-radius: 50%; margin-right: 6px;
    }
    .status-online { background: #43b581; }
    .status-idle { background: #faa61a; }
    .status-dnd { background: #f04747; }
    .status-offline { background: #747f8d; }

    /* Avatar */
    .avatar {
      width: 36px; height: 36px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 700; color: #fff; flex-shrink: 0;
    }

    /* Grid */
    .grid-2 { display: flex; gap: 20px; flex-wrap: wrap; }
    .grid-2 > * { flex: 1; min-width: 300px; }

    .page-title { font-size: 22px; font-weight: 800; color: #fff; margin-bottom: 4px; }
    .page-desc { color: #6b6d8a; font-size: 13px; margin-bottom: 24px; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ============================================
    // Vanilla JS Dashboard (no build step needed)
    // ============================================

    const API_BASE = '';
    let currentUser = null;
    let currentGuild = null;
    let activeTab = 'dashboard';
    let isOwner = false;

    // ============================================
    // API Helper
    // ============================================
    async function api(endpoint, options = {}) {
      const res = await fetch(API_BASE + endpoint, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          ...options.headers,
        },
        credentials: 'include',
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: 'Unknown error' }));
        throw new Error(err.error || `HTTP ${res.status}`);
      }
      return res.json();
    }

    // ============================================
    // Toast
    // ============================================
    function showToast(msg) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2500);
    }

    // ============================================
    // Login Page
    // ============================================
    function renderLogin() {
      return `
        <div class="login-page">
          <div class="login-card">
            <div class="login-icon">ğŸ¤–</div>
            <h1 style="font-size:28px;font-weight:800;color:#fff;margin-bottom:8px">Admin Bot</h1>
            <p style="font-size:14px;color:#6b6d8a;margin-bottom:32px;line-height:1.6">
              ë””ìŠ¤ì½”ë“œ ì„œë²„ë¥¼ ì›¹ì—ì„œ ê´€ë¦¬í•˜ì„¸ìš”
            </p>
            <a href="/auth/discord" class="login-btn">
              <svg width="20" height="15" viewBox="0 0 71 55" fill="none">
                <path d="M60.1 4.9A58.5 58.5 0 0045.4.2a.2.2 0 00-.2.1 40.8 40.8 0 00-1.8 3.7 54 54 0 00-16.2 0A37.4 37.4 0 0025.4.3a.2.2 0 00-.2-.1A58.4 58.4 0 0010.6 4.9a.2.2 0 00-.1.1C1.5 18.7-.9 32 .3 45.2v.1a58.7 58.7 0 0017.9 9 .2.2 0 00.3-.1 42 42 0 003.6-5.9.2.2 0 00-.1-.3 38.7 38.7 0 01-5.5-2.6.2.2 0 01 0-.4l1.1-.9a.2.2 0 01.2 0 41.9 41.9 0 0035.6 0 .2.2 0 01.2 0l1.1.9a.2.2 0 010 .4 36.3 36.3 0 01-5.5 2.6.2.2 0 00-.1.3 47.2 47.2 0 003.6 5.9.2.2 0 00.3.1 58.5 58.5 0 0018-9v-.1c1.4-14.8-2.3-27.7-9.9-39.1a.2.2 0 00-.1-.1zM23.7 37.1c-3.4 0-6.2-3.1-6.2-6.9s2.7-6.9 6.2-6.9 6.3 3.1 6.2 6.9c0 3.8-2.8 6.9-6.2 6.9zm22.9 0c-3.4 0-6.2-3.1-6.2-6.9s2.7-6.9 6.2-6.9 6.3 3.1 6.2 6.9c0 3.8-2.7 6.9-6.2 6.9z" fill="white"/>
              </svg>
              Discordë¡œ ë¡œê·¸ì¸
            </a>
            <p style="font-size:11px;color:#4d4f6a;margin-top:16px">ì„œë²„ ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</p>
          </div>
        </div>
      `;
    }

    // ============================================
    // Sidebar
    // ============================================
    function renderSidebar() {
      const tabs = [
        { id: 'dashboard', icon: 'ğŸ“Š', label: 'ëŒ€ì‹œë³´ë“œ' },
        { id: 'channels', icon: 'ğŸ“', label: 'ì±„ë„ ê´€ë¦¬' },
        { id: 'roles', icon: 'ğŸ‘¤', label: 'ì—­í•  ê´€ë¦¬' },
        { id: 'members', icon: 'ğŸ‘¥', label: 'ë©¤ë²„ ê´€ë¦¬' },
        { id: 'templates', icon: 'ğŸ› ï¸', label: 'ì„œë²„ êµ¬ì„±' },
        { id: 'patchnotes', icon: 'ğŸ“°', label: 'íŒ¨ì¹˜ë…¸íŠ¸' },
        { id: 'tts', icon: 'ğŸ”Š', label: 'TTS' },
        { id: 'settings', icon: 'âš™ï¸', label: 'ì„¤ì •' },
        ...(isOwner ? [{ id: 'membership', icon: 'ğŸ’³', label: 'ë©¤ë²„ì‹­ ê´€ë¦¬' }] : []),
      ];

      const guildName = currentGuild?.name || 'ì„œë²„ ì„ íƒ';
      const username = currentUser?.username || 'User';

      return `
        <div class="sidebar">
          <div class="sidebar-logo">
            <div style="display:flex;align-items:center;gap:10px">
              <div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#5865F2,#7c3aed);display:flex;align-items:center;justify-content:center;font-size:20px">ğŸ¤–</div>
              <div>
                <div style="font-size:14px;font-weight:700;color:#fff">Admin Bot</div>
                <div style="font-size:11px;color:#43b581">â— ì˜¨ë¼ì¸</div>
              </div>
            </div>
          </div>

          <div class="sidebar-server">
            <div class="nav-label">ì„œë²„</div>
            <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:10px;background:#1a1b2e">
              <div style="width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,#f59e0b,#ef4444);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#fff">
                ${guildName[0]}
              </div>
              <div style="font-size:13px;font-weight:600;color:#e2e4f0">${guildName}</div>
            </div>
          </div>

          <div class="sidebar-nav">
            <div class="nav-label">ë©”ë‰´</div>
            ${tabs.map(t => `
              <div class="nav-item ${activeTab === t.id ? 'active' : ''}" onclick="navigate('${t.id}')">
                <span style="font-size:16px">${t.icon}</span>
                <span>${t.label}</span>
              </div>
            `).join('')}
          </div>

          <div class="sidebar-footer">
            <div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
              <div style="display:flex;align-items:center;gap:10px">
                <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#43b581,#3498db);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff">
                  ${username[0]}
                </div>
                <div>
                  <div style="font-size:12px;font-weight:600;color:#e2e4f0">${username}</div>
                  <div style="font-size:10px;color:#5d5f7a">ê´€ë¦¬ì</div>
                </div>
              </div>
              <button onclick="logout()" style="background:none;border:none;color:#5d5f7a;cursor:pointer;font-size:16px" title="ë¡œê·¸ì•„ì›ƒ">ğŸšª</button>
            </div>
          </div>
        </div>
      `;
    }

    // ============================================
    // Page Renderers
    // ============================================

    async function renderDashboard() {
      let stats = { totalMembers: 0, onlineMembers: 0, channelCount: 0, roleCount: 0, boostCount: 0, boostLevel: 0 };

      if (currentGuild) {
        try {
          stats = await api(`/api/guilds/${currentGuild.id}/stats`);
        } catch (e) { console.error(e); }
      }

      return `
        <h2 class="page-title">ëŒ€ì‹œë³´ë“œ</h2>
        <p class="page-desc">ì„œë²„ í˜„í™©ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>

        <div class="stats-grid">
          <div class="card stat-card">
            <div style="font-size:24px;margin-bottom:8px">ğŸ‘¥</div>
            <div class="stat-value">${stats.totalMembers}</div>
            <div class="stat-label">ì´ ë©¤ë²„</div>
          </div>
          <div class="card stat-card">
            <div style="font-size:24px;margin-bottom:8px">ğŸŸ¢</div>
            <div class="stat-value">${stats.onlineMembers}</div>
            <div class="stat-label">ì˜¨ë¼ì¸</div>
          </div>
          <div class="card stat-card">
            <div style="font-size:24px;margin-bottom:8px">ğŸ“</div>
            <div class="stat-value">${stats.channelCount}</div>
            <div class="stat-label">ì±„ë„ ìˆ˜</div>
          </div>
          <div class="card stat-card">
            <div style="font-size:24px;margin-bottom:8px">ğŸ‘¤</div>
            <div class="stat-value">${stats.roleCount}</div>
            <div class="stat-label">ì—­í•  ìˆ˜</div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">ğŸ“Š ì„œë²„ ì •ë³´</div>
          ${currentGuild ? `
            <div style="display:flex;flex-direction:column;gap:12px">
              <div style="display:flex;justify-content:space-between"><span style="color:#8b8db3">ì„œë²„ ì´ë¦„</span><span style="font-weight:600">${currentGuild.name}</span></div>
              <div style="display:flex;justify-content:space-between"><span style="color:#8b8db3">ë¶€ìŠ¤íŠ¸</span><span style="font-weight:600">ë ˆë²¨ ${stats.boostLevel} (${stats.boostCount}ê°œ)</span></div>
              <div style="display:flex;justify-content:space-between"><span style="color:#8b8db3">ì„œë²„ ID</span><span style="font-weight:600;font-family:'JetBrains Mono',monospace;font-size:12px">${currentGuild.id}</span></div>
            </div>
          ` : '<div style="color:#5d5f7a">ì„œë²„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>'}
        </div>
      `;
    }

    async function renderChannels() {
      if (!currentGuild) return '<div class="card"><p style="color:#faa61a">âš ï¸ ì„œë²„ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p></div>';

      let channels = [];
      try { channels = await api(`/api/guilds/${currentGuild.id}/channels`); }
      catch (e) { return `<div class="card"><p style="color:#f04747">âŒ ${e.message}</p></div>`; }

      // Group by category
      const categories = {};
      channels.forEach(ch => {
        const cat = ch.parentName || 'ê¸°íƒ€';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(ch);
      });

      return `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
          <div>
            <h2 class="page-title">ì±„ë„ ê´€ë¦¬</h2>
            <p class="page-desc">ì´ ${channels.length}ê°œ ì±„ë„</p>
          </div>
          <button class="btn btn-primary" onclick="createChannelPrompt()">+ ì±„ë„ ìƒì„±</button>
        </div>

        ${Object.entries(categories).map(([cat, chs]) => `
          <div style="margin-bottom:20px">
            <div style="font-size:12px;font-weight:700;color:#5d5f7a;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">${cat}</div>
            ${chs.map(ch => `
              <div class="list-item">
                <div style="display:flex;align-items:center;gap:10px">
                  <span>${ch.type === 2 ? 'ğŸ”Š' : '#'}</span>
                  <span style="font-weight:600">${ch.name}</span>
                </div>
                <button class="btn btn-danger" style="padding:4px 12px;font-size:11px" onclick="deleteChannel('${ch.id}')">ì‚­ì œ</button>
              </div>
            `).join('')}
          </div>
        `).join('')}
      `;
    }

    async function renderRoles() {
      if (!currentGuild) return '<div class="card"><p style="color:#faa61a">âš ï¸ ì„œë²„ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p></div>';

      let roles = [];
      try { roles = await api(`/api/guilds/${currentGuild.id}/roles`); }
      catch (e) { return `<div class="card"><p style="color:#f04747">âŒ ${e.message}</p></div>`; }

      return `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
          <div>
            <h2 class="page-title">ì—­í•  ê´€ë¦¬</h2>
            <p class="page-desc">ì´ ${roles.length}ê°œ ì—­í• </p>
          </div>
          <button class="btn btn-primary" onclick="createRolePrompt()">+ ì—­í•  ìƒì„±</button>
        </div>

        ${roles.map(r => `
          <div class="list-item">
            <div style="display:flex;align-items:center;gap:12px">
              <div style="width:16px;height:16px;border-radius:50%;background:${r.color};flex-shrink:0"></div>
              <span style="font-weight:600">${r.name}</span>
              <span class="badge" style="background:#8b8db322;color:#8b8db3;border:1px solid #8b8db344">${r.members}ëª…</span>
              ${r.permissions.includes('Administrator') ? '<span class="badge" style="background:#f0474722;color:#f04747;border:1px solid #f0474744">ê´€ë¦¬ì</span>' : ''}
            </div>
            <button class="btn btn-danger" style="padding:4px 12px;font-size:11px" onclick="deleteRole('${r.id}')">ì‚­ì œ</button>
          </div>
        `).join('')}
      `;
    }

    async function renderMembers() {
      if (!currentGuild) {
        return '<div class="card"><p style="color:#faa61a">âš ï¸ ì„œë²„ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p></div>';
      }

      let members = [];
      try {
        members = await api(`/api/guilds/${currentGuild.id}/members`);
        console.log(`ë©¤ë²„ ${members.length}ëª… ë¡œë“œë¨`);
      } catch (e) {
        console.error('ë©¤ë²„ ë¡œë“œ ì‹¤íŒ¨:', e);
        return `<div class="card"><p style="color:#f04747">âŒ ë©¤ë²„ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</p></div>`;
      }

      return `
        <h2 class="page-title">ë©¤ë²„ ê´€ë¦¬</h2>
        <p class="page-desc">ì´ ${members.length}ëª…</p>

        <input class="input" id="memberSearch" placeholder="ğŸ” ë©¤ë²„ ê²€ìƒ‰..." style="width:100%;margin-bottom:20px" oninput="filterMembers()">

        <div id="memberList">
          ${members.map(m => `
            <div class="list-item member-item" data-name="${m.displayName.toLowerCase()}">
              <div style="display:flex;align-items:center;gap:12px">
                <div class="avatar" style="background:linear-gradient(135deg,#5865F2,#7c3aed)">
                  ${m.avatar ? `<img src="${m.avatar}" style="width:36px;height:36px;border-radius:50%">` : m.displayName[0]}
                </div>
                <div>
                  <div style="display:flex;align-items:center;gap:6px">
                    <span class="status-dot status-${m.status}"></span>
                    <span style="font-weight:600">${m.displayName}</span>
                  </div>
                  <div style="display:flex;gap:4px;margin-top:4px;flex-wrap:wrap">
                    ${m.roles.slice(0, 3).map(r => `<span class="badge" style="background:${r.color}22;color:${r.color};border:1px solid ${r.color}44">${r.name}</span>`).join('')}
                    ${m.roles.length > 3 ? `<span class="badge" style="background:#5d5f7a22;color:#5d5f7a;border:1px solid #5d5f7a44">+${m.roles.length - 3}</span>` : ''}
                  </div>
                </div>
              </div>
              <div style="display:flex;gap:6px">
                <button class="btn btn-warning" style="padding:4px 10px;font-size:11px" onclick="timeoutMember('${m.id}')">íƒ€ì„ì•„ì›ƒ</button>
                <button class="btn btn-danger" style="padding:4px 10px;font-size:11px" onclick="kickMember('${m.id}')">í‚¥</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderTemplates() {
      const templates = [
        { id: 'gaming', name: 'ğŸ® ê²Œì„ ì»¤ë®¤ë‹ˆí‹°', desc: 'ë¡¤, ë°œë¡œ, ë§ˆí¬ ë“± ê²Œì„ ì±„ë„ + ìŒì„±ë°©', cats: 4, chs: 18, roles: 5 },
        { id: 'study', name: 'ğŸ“š ìŠ¤í„°ë”” ê·¸ë£¹', desc: 'ìë£Œê³µìœ , TIL, ìŠ¤í„°ë””ë£¸', cats: 4, chs: 14, roles: 4 },
        { id: 'project', name: 'ğŸ¢ í”„ë¡œì íŠ¸ íŒ€', desc: 'ë°±ì—”ë“œ/í”„ë¡ íŠ¸ ì±„ë„, ìŠ¤í¬ëŸ¼, Git ë¡œê·¸', cats: 5, chs: 17, roles: 5 },
        { id: 'community', name: 'ğŸµ ì»¤ë®¤ë‹ˆí‹°', desc: 'ì·¨ë¯¸/ê´€ì‹¬ì‚¬ ì»¤ë®¤ë‹ˆí‹°', cats: 4, chs: 16, roles: 4 },
        { id: 'business', name: 'ğŸª ë¹„ì¦ˆë‹ˆìŠ¤', desc: 'ì‡¼í•‘ëª°/ë¸Œëœë“œ ì»¤ë®¤ë‹ˆí‹°', cats: 4, chs: 14, roles: 4 },
      ];

      return `
        <h2 class="page-title">ì„œë²„ êµ¬ì„±</h2>
        <p class="page-desc">í…œí”Œë¦¿ìœ¼ë¡œ ì„œë²„ë¥¼ ì›í´ë¦­ êµ¬ì„±í•©ë‹ˆë‹¤</p>

        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px">
          ${templates.map(t => `
            <div class="card">
              <div style="font-size:24px;margin-bottom:12px">${t.name.split(' ')[0]}</div>
              <div style="font-size:16px;font-weight:700;color:#fff;margin-bottom:8px">${t.name}</div>
              <div style="font-size:12px;color:#6b6d8a;margin-bottom:16px">${t.desc}</div>
              <div style="display:flex;gap:8px;margin-bottom:16px">
                <span class="badge" style="background:#5865F222;color:#5865F2;border:1px solid #5865F244">${t.cats}ê°œ ì¹´í…Œê³ ë¦¬</span>
                <span class="badge" style="background:#43b58122;color:#43b581;border:1px solid #43b58144">${t.chs}ê°œ ì±„ë„</span>
              </div>
              <button class="btn btn-primary" style="width:100%" onclick="applyTemplate('${t.id}')">ğŸ› ï¸ ì ìš©</button>
            </div>
          `).join('')}
        </div>
      `;
    }

    async function renderPatchNotes() {
      let status = {};
      try { status = await api('/api/patchnotes/status'); } catch (e) {}

      return `
        <h2 class="page-title">íŒ¨ì¹˜ë…¸íŠ¸ ê´€ë¦¬</h2>
        <p class="page-desc">ê²Œì„ë³„ íŒ¨ì¹˜ë…¸íŠ¸ ìë™ ì•Œë¦¼ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>

        <div class="card" style="margin-bottom:16px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="display:flex;align-items:center;gap:12px">
              <span style="font-size:28px">ğŸ®</span>
              <div>
                <div style="font-size:15px;font-weight:700;color:#fff">ë¦¬ê·¸ ì˜¤ë¸Œ ë ˆì „ë“œ</div>
                <div style="font-size:11px;color:#6b6d8a;margin-top:2px">
                  ë§ˆì§€ë§‰: ${status.lastTitle || 'ê¸°ë¡ ì—†ìŒ'}
                </div>
              </div>
            </div>
            <span class="badge" style="background:${status.aiEnabled ? '#43b58122' : '#6b6d8a22'};color:${status.aiEnabled ? '#43b581' : '#6b6d8a'};border:1px solid ${status.aiEnabled ? '#43b58144' : '#6b6d8a44'}">
              AI ìš”ì•½ ${status.aiEnabled ? 'ON' : 'OFF'}
            </span>
          </div>
          <div style="margin-top:12px">
            <button class="btn btn-primary" onclick="checkPatchNotes()">ğŸ“° ìµœì‹  íŒ¨ì¹˜ë…¸íŠ¸ ê°€ì ¸ì˜¤ê¸°</button>
          </div>
        </div>
      `;
    }

    function renderSettings() {
      return `
        <h2 class="page-title">ì„¤ì •</h2>
        <p class="page-desc">ë´‡ ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>

        <div class="card" style="margin-bottom:16px">
          <div class="card-title">âš™ï¸ ì„œë²„ ì„¤ì •</div>
          <div style="display:flex;flex-direction:column;gap:14px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span style="color:#8b8db3">ì„œë²„ ì´ë¦„ ë³€ê²½</span>
              <div style="display:flex;gap:8px">
                <input class="input" id="serverName" placeholder="ìƒˆ ì„œë²„ ì´ë¦„" style="width:200px">
                <button class="btn btn-success" onclick="changeServerName()">ë³€ê²½</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">ğŸ¤– ë´‡ ì •ë³´</div>
          <div style="display:flex;flex-direction:column;gap:12px">
            <div style="display:flex;justify-content:space-between"><span style="color:#8b8db3">ë´‡ ë²„ì „</span><span style="font-weight:600">1.0.0</span></div>
            <div style="display:flex;justify-content:space-between"><span style="color:#8b8db3">discord.js</span><span style="font-weight:600">v14</span></div>
            <div style="display:flex;justify-content:space-between"><span style="color:#8b8db3">Node.js</span><span style="font-weight:600">${typeof process !== 'undefined' ? 'Server' : 'Client'}</span></div>
          </div>
        </div>
      `;
    }

    // ============================================
    // Membership (ë´‡ ì˜¤ë„ˆ ì „ìš©)
    // ============================================
    let membershipGuilds = []; // ë´‡ì´ ì°¸ì—¬í•œ ì„œë²„ ëª©ë¡ ìºì‹œ

    async function renderMembership() {
      if (!isOwner) return '<div class="card"><p>ë´‡ ì˜¤ë„ˆë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p></div>';

      try {
        const stats = await api('/api/membership/stats');
        const data = await api('/api/membership');

        // ì„œë²„ ì„ íƒ ì˜µì…˜
        const guilds = Object.entries(data);

        let usersHtml = '';
        if (guilds.length === 0) {
          usersHtml = '<p style="color:#5d5f7a;padding:16px">ë©¤ë²„ì‹­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
          for (const [guildId, guildInfo] of guilds) {
            const users = Object.entries(guildInfo.users);
            if (users.length === 0) continue;

            usersHtml += `<div style="margin-bottom:20px">
              <div style="font-size:14px;font-weight:700;color:#fff;margin-bottom:12px;padding:8px 12px;background:#1a1b2e;border-radius:8px">
                ğŸ  ${guildInfo.guildName} <span style="color:#5d5f7a;font-weight:400">(${users.length}ëª…)</span>
              </div>`;

            for (const [userId, info] of users) {
              const creditColor = info.credits > 0 ? '#43b581' : '#f04747';
              usersHtml += `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid #1a1b2e" data-guild="${guildId}" data-user="${userId}">
                  <div style="display:flex;align-items:center;gap:10px">
                    ${info.avatar ? `<img src="${info.avatar}" style="width:32px;height:32px;border-radius:50%">` : `<div style="width:32px;height:32px;border-radius:50%;background:#2d2f45;display:flex;align-items:center;justify-content:center;font-size:12px">ğŸ‘¤</div>`}
                    <div>
                      <div style="font-size:13px;font-weight:600">${info.displayName || info.username}</div>
                      <div style="font-size:11px;color:#5d5f7a">${info.tier || 'ë¯¸êµ¬ë§¤'}</div>
                    </div>
                  </div>
                  <div style="display:flex;align-items:center;gap:12px">
                    <div style="text-align:right">
                      <div style="font-size:15px;font-weight:700;color:${creditColor}">${info.credits}íšŒ</div>
                      <div style="font-size:10px;color:#5d5f7a">ì´ ${info.totalPurchased || 0}íšŒ êµ¬ë§¤</div>
                    </div>
                    <button class="btn btn-success" style="padding:6px 12px;font-size:11px" onclick="chargeCredit('${guildId}','${userId}','${(info.displayName || info.username).replace(/'/g, "\\'")}')">ì¶©ì „</button>
                  </div>
                </div>`;
            }
            usersHtml += '</div>';
          }
        }

        return `
          <h2 class="page-title">ğŸ’³ ë©¤ë²„ì‹­ ê´€ë¦¬</h2>
          <p class="page-desc">ëª¨ë“  ì„œë²„ì˜ AI ë¶„ì„ í¬ë ˆë”§ì„ ê´€ë¦¬í•©ë‹ˆë‹¤ (ë´‡ ì˜¤ë„ˆ ì „ìš©)</p>

          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px">
            <div class="card" style="text-align:center;padding:20px">
              <div style="font-size:24px;font-weight:800;color:#fff">${stats.totalUsers}</div>
              <div style="font-size:11px;color:#5d5f7a;margin-top:4px">ì „ì²´ ìœ ì €</div>
            </div>
            <div class="card" style="text-align:center;padding:20px">
              <div style="font-size:24px;font-weight:800;color:#43b581">${stats.totalCreditsRemaining}</div>
              <div style="font-size:11px;color:#5d5f7a;margin-top:4px">ì”ì—¬ í¬ë ˆë”§</div>
            </div>
            <div class="card" style="text-align:center;padding:20px">
              <div style="font-size:24px;font-weight:800;color:#5865F2">${stats.totalPurchased}</div>
              <div style="font-size:11px;color:#5d5f7a;margin-top:4px">ì´ êµ¬ë§¤ëŸ‰</div>
            </div>
            <div class="card" style="text-align:center;padding:20px">
              <div style="font-size:24px;font-weight:800;color:#f0b232">${stats.totalUsed}</div>
              <div style="font-size:11px;color:#5d5f7a;margin-top:4px">ì´ ì‚¬ìš©ëŸ‰</div>
            </div>
          </div>

          <div class="card" style="margin-bottom:20px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="card-title" style="margin-bottom:0">ğŸ‘¥ ìœ ì €ë³„ í¬ë ˆë”§</div>
              <button class="btn btn-primary" onclick="openNewChargeModal()">â• ìƒˆ ìœ ì € ì¶©ì „</button>
            </div>
          </div>

          <div class="card">
            ${usersHtml}
          </div>

          <!-- ìƒˆ ìœ ì € ì¶©ì „ ëª¨ë‹¬ -->
          <div id="chargeModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:999;display:none;align-items:center;justify-content:center">
            <div style="background:#1e1f2e;border:1px solid #2d2f45;border-radius:16px;padding:28px;width:420px;max-width:90%">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h3 style="font-size:16px;font-weight:700;color:#fff">â• ìƒˆ ìœ ì € í¬ë ˆë”§ ì¶©ì „</h3>
                <button onclick="closeChargeModal()" style="background:none;border:none;color:#5d5f7a;font-size:18px;cursor:pointer">âœ•</button>
              </div>

              <div style="margin-bottom:16px">
                <label style="font-size:12px;color:#8b8db3;display:block;margin-bottom:6px">ì„œë²„ ì„ íƒ</label>
                <select id="modalGuildSelect" class="input" style="width:100%" onchange="loadModalMembers()">
                  <option value="">ì„œë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
              </div>

              <div style="margin-bottom:16px">
                <label style="font-size:12px;color:#8b8db3;display:block;margin-bottom:6px">ë©¤ë²„ ì„ íƒ</label>
                <select id="modalMemberSelect" class="input" style="width:100%">
                  <option value="">ë¨¼ì € ì„œë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
              </div>

              <div style="margin-bottom:16px">
                <label style="font-size:12px;color:#8b8db3;display:block;margin-bottom:6px">í¬ë ˆë”§ ìˆ˜ëŸ‰</label>
                <div style="display:flex;gap:8px;margin-bottom:8px">
                  <button class="btn" style="background:#5d5f7a33;color:#e2e4f0;flex:1" onclick="document.getElementById('modalAmount').value=8">ğŸ¥‰ 8</button>
                  <button class="btn" style="background:#5865F233;color:#5865F2;flex:1" onclick="document.getElementById('modalAmount').value=40">ğŸ¥ˆ 40</button>
                  <button class="btn" style="background:#43b58133;color:#43b581;flex:1" onclick="document.getElementById('modalAmount').value=83">ğŸ¥‡ 83</button>
                </div>
                <input type="number" id="modalAmount" class="input" style="width:100%" placeholder="ì§ì ‘ ì…ë ¥..." min="1">
              </div>

              <div style="margin-bottom:20px">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                  <input type="checkbox" id="modalSendDm" checked style="width:16px;height:16px">
                  <span style="font-size:13px;color:#8b8db3">ì¶©ì „ ì™„ë£Œ í›„ ìœ ì €ì—ê²Œ DM ì•Œë¦¼ ì „ì†¡</span>
                </label>
              </div>

              <button class="btn btn-success" style="width:100%;padding:12px" onclick="submitNewCharge()">âœ… ì¶©ì „í•˜ê¸°</button>
            </div>
          </div>
        `;
      } catch (e) {
        return `<div class="card"><p style="color:#f04747">ë©¤ë²„ì‹­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}</p></div>`;
      }
    }

    async function openNewChargeModal() {
      const modal = document.getElementById('chargeModal');
      modal.style.display = 'flex';

      // ì„œë²„ ëª©ë¡ ë¡œë“œ
      try {
        membershipGuilds = await api('/api/membership/guilds');
        const select = document.getElementById('modalGuildSelect');
        select.innerHTML = '<option value="">ì„œë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>' +
          membershipGuilds.map(g => `<option value="${g.id}">${g.name} (${g.memberCount}ëª…)</option>`).join('');
      } catch (e) {
        showToast('âŒ ì„œë²„ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
      }
    }

    function closeChargeModal() {
      document.getElementById('chargeModal').style.display = 'none';
    }

    async function loadModalMembers() {
      const guildId = document.getElementById('modalGuildSelect').value;
      const select = document.getElementById('modalMemberSelect');

      if (!guildId) {
        select.innerHTML = '<option value="">ë¨¼ì € ì„œë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
        return;
      }

      select.innerHTML = '<option value="">ë¡œë”© ì¤‘...</option>';

      try {
        const members = await api(`/api/membership/guilds/${guildId}/members`);
        select.innerHTML = '<option value="">ë©¤ë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>' +
          members.map(m => {
            const tag = m.credits > 0 ? ` [${m.credits}íšŒ]` : '';
            return `<option value="${m.id}" data-name="${m.displayName}">${m.displayName} (@${m.username})${tag}</option>`;
          }).join('');
      } catch (e) {
        select.innerHTML = '<option value="">ë©¤ë²„ ë¡œë“œ ì‹¤íŒ¨</option>';
        showToast('âŒ ' + e.message);
      }
    }

    async function submitNewCharge() {
      const guildId = document.getElementById('modalGuildSelect').value;
      const memberSelect = document.getElementById('modalMemberSelect');
      const userId = memberSelect.value;
      const amount = parseInt(document.getElementById('modalAmount').value);
      const sendDm = document.getElementById('modalSendDm').checked;

      if (!guildId) return showToast('âŒ ì„œë²„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
      if (!userId) return showToast('âŒ ë©¤ë²„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
      if (!amount || amount <= 0) return showToast('âŒ í¬ë ˆë”§ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');

      const username = memberSelect.options[memberSelect.selectedIndex]?.text || userId;

      try {
        const result = await api(`/api/membership/${guildId}/${userId}/charge`, {
          method: 'POST',
          body: JSON.stringify({ amount, sendDm }),
        });
        const dmMsg = result.dmSent ? ' (DM ì•Œë¦¼ ì „ì†¡ë¨)' : '';
        showToast(`âœ… ${username}ì—ê²Œ ${amount}íšŒ ì¶©ì „ ì™„ë£Œ!${dmMsg}`);
        closeChargeModal();
        render();
      } catch (e) {
        showToast('âŒ ' + e.message);
      }
    }

    async function chargeCredit(guildId, userId, username) {
      const amount = prompt(`${username}ë‹˜ì—ê²Œ ì¶©ì „í•  í¬ë ˆë”§ ìˆ˜:\n\nğŸ¥‰ ë¸Œë¡ ì¦ˆ: 8íšŒ (1,000ì›)\nğŸ¥ˆ ì‹¤ë²„: 40íšŒ (5,000ì›)\nğŸ¥‡ ê³¨ë“œ: 83íšŒ (10,000ì›)`);
      if (!amount || isNaN(amount) || Number(amount) <= 0) return;

      try {
        const result = await api(`/api/membership/${guildId}/${userId}/charge`, {
          method: 'POST',
          body: JSON.stringify({ amount: Number(amount), sendDm: true }),
        });
        const dmMsg = result.dmSent ? ' (DM ì•Œë¦¼ ì „ì†¡ë¨)' : '';
        showToast(`âœ… ${username}ë‹˜ì—ê²Œ ${amount}íšŒ í¬ë ˆë”§ ì¶©ì „ ì™„ë£Œ!${dmMsg}`);
        render();
      } catch (e) {
        showToast('âŒ ' + e.message);
      }
    }

    // ============================================
    // Action Handlers
    // ============================================

    async function createChannelPrompt() {
      const name = prompt('ì±„ë„ ì´ë¦„:');
      if (!name) return;
      const type = confirm('ìŒì„± ì±„ë„? (ì·¨ì†Œ = í…ìŠ¤íŠ¸)') ? 2 : 0;
      try {
        await api(`/api/guilds/${currentGuild.id}/channels`, {
          method: 'POST',
          body: JSON.stringify({ name, type }),
        });
        showToast('âœ… ì±„ë„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
        render();
      } catch (e) { showToast('âŒ ' + e.message); }
    }

    async function deleteChannel(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        await api(`/api/guilds/${currentGuild.id}/channels/${id}`, { method: 'DELETE' });
        showToast('ğŸ—‘ï¸ ì±„ë„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
        render();
      } catch (e) { showToast('âŒ ' + e.message); }
    }

    async function createRolePrompt() {
      const name = prompt('ì—­í•  ì´ë¦„:');
      if (!name) return;
      const color = prompt('ìƒ‰ìƒ ì½”ë“œ (ì˜ˆ: #FF0000):', '#5865F2') || '#5865F2';
      try {
        await api(`/api/guilds/${currentGuild.id}/roles`, {
          method: 'POST',
          body: JSON.stringify({ name, color }),
        });
        showToast('âœ… ì—­í• ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
        render();
      } catch (e) { showToast('âŒ ' + e.message); }
    }

    async function deleteRole(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        await api(`/api/guilds/${currentGuild.id}/roles/${id}`, { method: 'DELETE' });
        showToast('ğŸ—‘ï¸ ì—­í• ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
        render();
      } catch (e) { showToast('âŒ ' + e.message); }
    }

    async function kickMember(id) {
      if (!confirm('ì •ë§ ì¶”ë°©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        await api(`/api/guilds/${currentGuild.id}/members/${id}/kick`, { method: 'POST' });
        showToast('ğŸ‘¢ ë©¤ë²„ê°€ ì¶”ë°©ë˜ì—ˆìŠµë‹ˆë‹¤!');
        render();
      } catch (e) { showToast('âŒ ' + e.message); }
    }

    async function timeoutMember(id) {
      const min = prompt('íƒ€ì„ì•„ì›ƒ ì‹œê°„ (ë¶„):', '5');
      if (!min) return;
      try {
        await api(`/api/guilds/${currentGuild.id}/members/${id}/timeout`, {
          method: 'POST',
          body: JSON.stringify({ minutes: parseInt(min) }),
        });
        showToast('â° íƒ€ì„ì•„ì›ƒ ì ìš©!');
      } catch (e) { showToast('âŒ ' + e.message); }
    }

    async function applyTemplate(id) {
      const clear = confirm('âš ï¸ ê¸°ì¡´ ì±„ë„ì„ ì‚­ì œí•˜ê³  êµ¬ì„±í• ê¹Œìš”?\n(ì·¨ì†Œ = ê¸°ì¡´ ìœ ì§€í•˜ê³  ì¶”ê°€)');
      try {
        const result = await api(`/api/guilds/${currentGuild.id}/setup`, {
          method: 'POST',
          body: JSON.stringify({ templateId: id, clearExisting: clear }),
        });
        showToast(`âœ… í…œí”Œë¦¿ ì ìš© ì™„ë£Œ! (ì—­í•  ${result.roles}ê°œ, ì±„ë„ ${result.channels}ê°œ)`);
      } catch (e) { showToast('âŒ ' + e.message); }
    }

    async function checkPatchNotes() {
      showToast('ğŸ” íŒ¨ì¹˜ë…¸íŠ¸ í™•ì¸ ì¤‘...');
      try {
        const channelId = prompt('íŒ¨ì¹˜ë…¸íŠ¸ë¥¼ ë³´ë‚¼ ì±„ë„ ID:');
        if (!channelId) return;
        await api(`/api/guilds/${currentGuild.id}/patchnotes/check`, {
          method: 'POST',
          body: JSON.stringify({ channelId }),
        });
        showToast('âœ… íŒ¨ì¹˜ë…¸íŠ¸ ì „ì†¡ ì™„ë£Œ!');
      } catch (e) { showToast('âŒ ' + e.message); }
    }

    async function changeServerName() {
      const name = document.getElementById('serverName')?.value;
      if (!name) return;
      try {
        await api(`/api/guilds/${currentGuild.id}/settings`, {
          method: 'PATCH',
          body: JSON.stringify({ name }),
        });
        showToast('âœ… ì„œë²„ ì´ë¦„ ë³€ê²½!');
        currentGuild.name = name;
        render();
      } catch (e) { showToast('âŒ ' + e.message); }
    }

    function filterMembers() {
      const q = document.getElementById('memberSearch')?.value.toLowerCase() || '';
      document.querySelectorAll('.member-item').forEach(el => {
        el.style.display = el.dataset.name.includes(q) ? '' : 'none';
      });
    }

    async function logout() {
      await api('/api/auth/logout', { method: 'POST' });
      currentUser = null;
      currentGuild = null;
      render();
    }

    function navigate(tab) {
      activeTab = tab;
      render();
    }

    // ============================================
    // Main Render
    // ============================================
    async function render() {
      const app = document.getElementById('app');

      if (!currentUser) {
        app.innerHTML = renderLogin();
        return;
      }

      let pageContent = '<div class="loading"><div class="spinner"></div>ë¡œë”© ì¤‘...</div>';

      app.innerHTML = `
        <div class="layout">
          ${renderSidebar()}
          <div class="main" id="pageContent">${pageContent}</div>
        </div>
      `;

      // Render page content
      const pageEl = document.getElementById('pageContent');
      try {
        switch (activeTab) {
          case 'dashboard': pageEl.innerHTML = await renderDashboard(); break;
          case 'channels': pageEl.innerHTML = await renderChannels(); break;
          case 'roles': pageEl.innerHTML = await renderRoles(); break;
          case 'members': pageEl.innerHTML = await renderMembers(); break;
          case 'templates': pageEl.innerHTML = renderTemplates(); break;
          case 'patchnotes': pageEl.innerHTML = await renderPatchNotes(); break;
          case 'settings': pageEl.innerHTML = renderSettings(); break;
          case 'membership': pageEl.innerHTML = await renderMembership(); break;
          default: pageEl.innerHTML = await renderDashboard();
        }
      } catch (e) {
        pageEl.innerHTML = `<div class="card"><p style="color:#f04747">ì˜¤ë¥˜: ${e.message}</p></div>`;
      }
    }

    // ============================================
    // Init
    // ============================================
    async function init() {
      try {
        const auth = await api('/api/auth/user');
        if (auth.loggedIn) {
          currentUser = auth.user;
          if (auth.user.guilds && auth.user.guilds.length > 0) {
            currentGuild = auth.user.guilds[0];
            console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ:', currentUser.username);
            console.log('âœ… ì„œë²„:', currentGuild.name, currentGuild.id);
          } else {
            console.log('âš ï¸ ê´€ë¦¬ ê°€ëŠ¥í•œ ì„œë²„ ì—†ìŒ');
          }

          // ë´‡ ì˜¤ë„ˆ ì—¬ë¶€ í™•ì¸
          try {
            const ownerRes = await api('/api/auth/is-owner');
            isOwner = ownerRes.isOwner;
            if (isOwner) console.log('ğŸ‘‘ ë´‡ ì˜¤ë„ˆ í™•ì¸');
          } catch (e) { /* ë¬´ì‹œ */ }
        }
      } catch (e) {
        console.log('Not logged in:', e.message);
      }
      render();
    }

    init();
  </script>
</body>
</html>